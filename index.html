<html>
  <head>
    <link rel="stylesheet" type="text/css" href="image.css">
    <script src="image.js"></script>
    <script>
      function isEl(node) {
        return node.tagName !== undefined;
      }

      function cloneTreeWithStyle(node) {
        // Clode the node
        var cloneNode = node.cloneNode(false);

        // Clone the computed style info
        if (isEl(node)) {
          // Get the effective style for the element
          var styleInfo = window.getComputedStyle(node, null);

          // Apply the style directly to the cloned element
          for (var propertyIdx = 0; propertyIdx < styleInfo.length; propertyIdx++) {
            var property = styleInfo[propertyIdx];

            // Do *NOT* set style info for attributes set directly on the element
            if (!(property in cloneNode)) {
              cloneNode.style[property] = styleInfo.getPropertyValue(property);
            }
          }

          //cloneNode.style.cssText = window.getComputedStyle(node, null).cssText;
        }

        // Recur
        node.childNodes.forEach(function(child, idx) {
          cloneNode.appendChild(cloneTreeWithStyle(child));
        });

        return cloneNode;
      }

      window.onload = function () {
        var imageParentEl = document.getElementById('imageDiv');
        window.image = new Image(221, 381, imageParentEl);

        var curColIdx = 0
        addBarFormEl = document.getElementById('addBarForm');
        addBarFormEl.onsubmit = function () {
          var name = addBarFormEl.figureName.value;
          var startYr = parseInt(addBarFormEl.startYr.value);
          var endYrStr = addBarFormEl.endYr.value;
          var endYr = null;
          if (endYrStr != "") {
            endYr = parseInt(endYrStr);
          }
          window.image.addBarEl('el' + curColIdx, name, startYr, endYr, 'lightblue', curColIdx);
          curColIdx++;
        };

        document.getElementById('download').onclick = function () {
          var DOMURL = window.URL || window.webkitURL || window;

          var svgEl = window.image.svgEl;
  
          var xmlSerializer = new XMLSerializer();
          var cloneSvgElWithStyle = cloneTreeWithStyle(svgEl);
          var svgContent = xmlSerializer.serializeToString(cloneSvgElWithStyle);
  
          var standaloneSvgContent = "<?xml version='1.0' ?>" + svgContent;
          var url = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(standaloneSvgContent);
  
          document.getElementById('download').href = url;
        };
      };
    </script>
  </head>
  <body>
    <div id="imageDiv"></div>
    <br />
    <form id="addBarForm" action="javascript:void(0);">
      Name: <input id="figureName" type="text" />
      <br />
      Start Year: <input id="startYr" type="text" />
      <br />
      End Year: <input id="endYr" type="text" />
      <br />
      <input type="submit" value="Add Bar" />
    </form>
    <br />
    <a id='download' download="history.svg" href="javascript:void(0);">Download</a>
    <canvas />
  </body>
</html>
