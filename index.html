<html>
  <head>
    <link rel="stylesheet" type="text/css" href="image.css">
  </head>
  <body>
    <svg id="image" xmlns="http://www.w3.org/2000/svg" version="1.1" width="221mm" height="331mm" viewBox="-0.5 -0.5 221 331">
      <rect class="bg" x="0" y="0" width="220" height="330" />
      <g id="decadeOffset">
        <g id="decades" />
        <g id="centuries" />
        <g id="figureRegion" transform="translate(60, 0)">
          <g id="figures" />
          <rect id="future" class="future" x="0" y="0" width="220" height="0">
        </g>
      </g>
      <rect x="0" y="0" width="220" height="330" fill="none" stroke="black" stroke-width="1" />
    </svg>
    <script>
      function buildEl(name, attrs, id) {
        var el = document.createElementNS("http://www.w3.org/2000/svg", name);
        for (var key in attrs) {
          el.setAttribute(key, attrs[key]);
        }

        if (id !== undefined) el.setAttribute('id', id);

        return el;
      }

      function getDecadeForYr(yr) {
        return Math.floor(yr / 10);
      }

      var curYr = new Date().getFullYear();
      var curDecade = getDecadeForYr(curYr);

      var decadeHeight = 30;  // TODO: Define as constant
      var decadeWidth = 60;

      function buildDecadeEl(decadeYr) {
        var decade = getDecadeForYr(decadeYr)

        var y = (curDecade - decade) * decadeHeight;

        var decadeAttrs = {
          'transform': 'translate(0, ' + y + ')'
        };
        var decadeEl = buildEl('g', decadeAttrs, 'decade' + decadeYr);

        var rectAttrs = {
          'x': 0, 'y': 0,
          'width': decadeWidth, 'height': decadeHeight,
          'style': "stroke:lightgray;fill:none;stroke-width:1"
        };
        var rectEl = buildEl('rect', rectAttrs);
        decadeEl.appendChild(rectEl);

        var textAttrs = {
          'x': decadeWidth / 2, 'y': decadeHeight / 2,
          'text-anchor': 'middle', 'alignment-baseline': 'central'
        }
        var textEl = buildEl('text', textAttrs);
        textEl.innerHTML = decadeYr;
        decadeEl.appendChild(textEl);

        return decadeEl;
      }

      function addDecadeEls(startYr, endYr) {
        var startDecade = getDecadeForYr(startYr);
        var endDecade = getDecadeForYr(endYr);

        // Generate all decade labels and add them to the DOM
        var decadesEl = document.getElementById("decades");
        for (var decade = startDecade; decade <= endDecade; decade++) {
          var decadeEl = buildDecadeEl(decade * 10);

          decadesEl.appendChild(decadeEl);
        }

        // Shift all elements up based on the end decade
        var offsetY = (endDecade - curDecade) * decadeHeight;

        var decadeOffsetEl = document.getElementById("decadeOffset");
        decadeOffsetEl.setAttribute("transform", "translate(0, " + offsetY + ")");
      }

      function buildCenturyEl(centuryYr, width) {
        centuryDecade = getDecadeForYr(centuryYr);

        var y = (curDecade - centuryDecade + 1) * decadeHeight;
        var pathAttrs = {
          'd': 'M 0 ' + y + ' L ' + width + ' ' + y,
          'stroke': 'black', 'fill': 'none',
          'stroke-dasharray': '5,5'
        };
        var pathEl = buildEl('path', pathAttrs);
        var centuriesEl = document.getElementById('centuries');
        centuriesEl.appendChild(pathEl);
      }

      function buildFigureEl(id, name, height, color, x, y) {
        var width = 30; // TODO: define as constant

        var figureAttrs = {};
        if (x !== undefined && y !== undefined) {
          figureAttrs['transform'] = "translate(" + x + ", " + y + ")";
        }
        var figureEl = buildEl('g', figureAttrs, id);

        var halfWidth = width / 2;
        var halfHeight = height / 2;
        var groupingTransforms = [
          "translate(" + halfWidth + ", " + -halfHeight + ")",
          "rotate(90)",
          "translate(" + halfHeight + ", " + -halfWidth + ")"
        ];

        var groupingEl = buildEl('g', {'transform': groupingTransforms.join(" ")});
        figureEl.appendChild(groupingEl);

        var rectAttrs = {
          'class': 'bar',
          'x': 0, 'y': 0,
          'width': height, 'height': width, // Yes, this looks backwards, but that's because the rotate(90) transform is being applied
          'fill': color
        };
        var rectEl = buildEl('rect', rectAttrs);
        groupingEl.appendChild(rectEl);

        var textAttrs = {
          'class': 'bar',
          'x': halfHeight, 'y': halfWidth // Yes, this looks backwards, but that's because the rotate(90) transform is being applied
        };
        var textEl = buildEl('text', textAttrs);
        textEl.innerHTML = name;
        groupingEl.appendChild(textEl);

        return figureEl;
      }

      function setFutureHeight() {
        var yrsIntoDecade = curYr - (curDecade * 10);
        var yrsLeftInDecade = 10 - yrsIntoDecade;

        var futureEl = document.getElementById("future");
        futureEl.setAttribute("height", yrsLeftInDecade * decadeHeight / 10);
      }

      var figureEl = buildFigureEl('frankId', 'Frank Longbottom', 200, 'green');
      var figuresEl = document.getElementById("figures");
      figuresEl.appendChild(figureEl);

      addDecadeEls(1904, 2017);

      buildCenturyEl(1900, 330);

      setFutureHeight();
    </script>
  </body>
</html>
